<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
		<head>
			<!-- template designed by Marco Von Ballmoos  -->
			<title>Mock objects</title>
			<link rel="stylesheet" href="../media/stylesheet.css" />
						<script src="../media/lib/classTree.js"></script>
												<script language="javascript" type="text/javascript">
				var imgPlus = new Image();
				var imgMinus = new Image();
				imgPlus.src = "../media/images/plus.png";
				imgMinus.src = "../media/images/minus.png";
				
				function showNode(Node){
							switch(navigator.family){
								case 'nn4':
									// Nav 4.x code fork...
							var oTable = document.layers["span" + Node];
							var oImg = document.layers["img" + Node];
									break;
								case 'ie4':
									// IE 4/5 code fork...
							var oTable = document.all["span" + Node];
							var oImg = document.all["img" + Node];
									break;
								case 'gecko':
									// Standards Compliant code fork...
							var oTable = document.getElementById("span" + Node);
							var oImg = document.getElementById("img" + Node);
									break;
							}
					oImg.src = imgMinus.src;
					oTable.style.display = "block";
				}
				
				function hideNode(Node){
							switch(navigator.family){
								case 'nn4':
									// Nav 4.x code fork...
							var oTable = document.layers["span" + Node];
							var oImg = document.layers["img" + Node];
									break;
								case 'ie4':
									// IE 4/5 code fork...
							var oTable = document.all["span" + Node];
							var oImg = document.all["img" + Node];
									break;
								case 'gecko':
									// Standards Compliant code fork...
							var oTable = document.getElementById("span" + Node);
							var oImg = document.getElementById("img" + Node);
									break;
							}
					oImg.src = imgPlus.src;
					oTable.style.display = "none";
				}
				
				function nodeIsVisible(Node){
							switch(navigator.family){
								case 'nn4':
									// Nav 4.x code fork...
							var oTable = document.layers["span" + Node];
									break;
								case 'ie4':
									// IE 4/5 code fork...
							var oTable = document.all["span" + Node];
									break;
								case 'gecko':
									// Standards Compliant code fork...
							var oTable = document.getElementById("span" + Node);
									break;
							}
					return (oTable && oTable.style.display == "block");
				}
				
				function toggleNodeVisibility(Node){
					if (nodeIsVisible(Node)){
						hideNode(Node);
					}else{
						showNode(Node);
					}
				}
			</script>
					</head>
		<body>
			<div class="page-body">			
	<table class="tutorial-nav-box">
	<tr>
		<td style="width: 30%">
							<a href="../SimpleTest/tutorial_GroupTests.pkg.html" class="nav-button">Previous</a>
					</td>
		<td style="text-align: center">
							<a href="../SimpleTest/tutorial_SimpleTest.pkg.html" class="nav-button">Up</a>
					</td>
		<td style="text-align: right; width: 30%">
							<a href="../SimpleTest/tutorial_PartialMock.pkg.html" class="nav-button">Next</a>
					</td>
	</tr>
	<tr>
		<td style="width: 30%">
							<span class="detail">Group tests</span>
					</td>
		<td style="text-align: center">
							<span class="detail">Simple Test PHP Unit Test Framework</span>
					</td>
		<td style="text-align: right; width: 30%">
							<span class="detail">Partial mocks</span>
					</td>
	</tr>
</table>
	
<div><a name=""></a><div class="ref-title-box"><h1 class="ref-title">Mock objects</h1>
<h2 class="ref-purpose"></h2></div>
            <h1 class="title">Table of Contents</h1>
<ul class="toc">
	
			
					<li><a href="../SimpleTest/tutorial_MockObjects.pkg.html#what">What are mock objects?</a></li>
					
					<li><a href="../SimpleTest/tutorial_MockObjects.pkg.html#creation">Creating mock objects</a></li>
					
					<li><a href="../SimpleTest/tutorial_MockObjects.pkg.html#expectations">Mocks as critics</a></li>
					</ul>

            
        <span><a name="what"></a><h2 class="title">What are mock objects?</h2><p>Mock objects have two roles during a test case: actor and critic.</p>
            <p>The actor behaviour is to simulate objects that are difficult to
                set up or time consuming to set up for a test.
                The classic example is a database connection.
                Setting up a test database at the start of each test would slow
                testing to a crawl and would require the installation of the
                database engine and test data on the test machine.
                If we can simulate the connection and return data of our
                choosing we not only win on the pragmatics of testing, but can
                also feed our code spurious data to see how it responds.
                We can simulate databases being down or other extremes
                without having to create a broken database for real.
                In other words, we get greater control of the test environment.</p>
            <p>If mock objects only behaved as actors they would simply be
                known as &quot;server stubs&quot;.
                This was originally a pattern named by Robert Binder (Testing: models, patterns, and tools,
                Addison-Wesley) in 1999.</p>
            <p>A server stub is a simulation of an object or component.
                It should exactly replace a component in a system for test
                or prototyping purposes, but remain lightweight.
                This allows tests to run more quickly, or if the simulated
                class has not been written, to run at all.</p>
            <p>However, the mock objects not only play a part (by supplying chosen
                return values on demand) they are also sensitive to the
                messages sent to them (via expectations).
                By setting expected parameters for a method call they act
                as a guard that the calls upon them are made correctly.
                If expectations are not met they save us the effort of
                writing a failed test assertion by performing that duty on our
                behalf.</p>
            <p>In the case of an imaginary database connection they can
                test that the query, say SQL, was correctly formed by
                the object that is using the connection.
                Set them up with fairly tight expectations and you will
                hardly need manual assertions at all.</p></span>
        <span><a name="creation"></a><h2 class="title">Creating mock objects</h2><p>All we need is an existing class or interface, say a database connection
                that looks like this...
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">DatabaseConnection&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">DatabaseConnection</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span><span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">query</span><span class="src-sym">(</span><span class="src-var">$sql</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span><span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">selectQuery</span><span class="src-sym">(</span><span class="src-var">$sql</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span><span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                To create a mock version of the class we need to run a
                code generator...
<div class="src-code"><ol><li><div class="src-line"><span class="src-inc">require_once</span><span class="src-sym">(</span><span class="src-str">'simpletest/autorun.php'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><span class="src-inc">require_once</span><span class="src-sym">(</span><span class="src-str">'database_connection.php'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line"><span class="src-id"><a href="../SimpleTest/MockObjects/Mock.html">Mock</a></span><span class="src-sym">::</span><a href="../SimpleTest/MockObjects/Mock.html#methodgenerate">generate</a><span class="src-sym">(</span><span class="src-str">'DatabaseConnection'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
</ol></div>
                This code generates a clone class called
                MockDatabaseConnection.
                This new class appears to be the same, but actually has no behaviour at all.</p>
            <p>The new class is usually a subclass of DatabaseConnection.
                Unfortunately, there is no way to create a mock version of a
                class with a final method without having a living version of
                that method.
                We consider that unsafe.
                If the target is an interface, or if final methods are
                present in a target class, then a whole new class
                is created, but one implemeting the same interfaces.
                If you try to pass this separate class through a type hint that specifies
                the old concrete class name, it will fail.
                Code like that insists on type hinting to a class with final
                methods probably cannot be safely tested with mocks.</p>
            <p>If you want to see the generated code, then simply print
                the output of Mock::generate().
                Here is the generated code for the DatabaseConnection
                class rather than the interface version...
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">MockDatabaseConnection&nbsp;</span><span class="src-key">extends&nbsp;</span><span class="src-id">DatabaseConnection&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">public&nbsp;</span><span class="src-var">$mock</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">protected&nbsp;</span><span class="src-var">$mocked_methods&nbsp;</span>=&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'databaseconnection'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'query'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'selectquery'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">MockDatabaseConnection</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$this</span><span class="src-sym">-&gt;</span><span class="src-var">mock&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id"><a href="../SimpleTest/MockObjects/SimpleMock.html">SimpleMock</a></span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$this</span><span class="src-sym">-&gt;</span><span class="src-var">mock</span><span class="src-sym">-&gt;</span><span class="src-id">disableExpectationNameChecks</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;...</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">DatabaseConnection</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$args&nbsp;</span>=&nbsp;<a href="http://www.php.net/func_get_args">func_get_args</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$result&nbsp;</span>=&nbsp;<span class="src-sym">&amp;</span><span class="src-var">$this</span><span class="src-sym">-&gt;</span><span class="src-var">mock</span><span class="src-sym">-&gt;</span><span class="src-id">invoke</span><span class="src-sym">(</span><span class="src-str">&quot;DatabaseConnection&quot;</span><span class="src-sym">,&nbsp;</span><span class="src-var">$args</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><span class="src-var">$result</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">query</span><span class="src-sym">(</span><span class="src-var">$sql</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$args&nbsp;</span>=&nbsp;<a href="http://www.php.net/func_get_args">func_get_args</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$result&nbsp;</span>=&nbsp;<span class="src-sym">&amp;</span><span class="src-var">$this</span><span class="src-sym">-&gt;</span><span class="src-var">mock</span><span class="src-sym">-&gt;</span><span class="src-id">invoke</span><span class="src-sym">(</span><span class="src-str">&quot;query&quot;</span><span class="src-sym">,&nbsp;</span><span class="src-var">$args</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><span class="src-var">$result</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">selectQuery</span><span class="src-sym">(</span><span class="src-var">$sql</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$args&nbsp;</span>=&nbsp;<a href="http://www.php.net/func_get_args">func_get_args</a><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$result&nbsp;</span>=&nbsp;<span class="src-sym">&amp;</span><span class="src-var">$this</span><span class="src-sym">-&gt;</span><span class="src-var">mock</span><span class="src-sym">-&gt;</span><span class="src-id">invoke</span><span class="src-sym">(</span><span class="src-str">&quot;selectQuery&quot;</span><span class="src-sym">,&nbsp;</span><span class="src-var">$args</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">return&nbsp;</span><span class="src-var">$result</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                Your output may vary depending on the exact version
                of SimpleTest you are using.</p>
            <p>Besides the original methods of the class, you will see some extra
                methods that help testing.
                More on these later.</p>
            <p>We can now create instances of the new class within
                our test case...
<div class="src-code"><ol><li><div class="src-line"><span class="src-inc">require_once</span><span class="src-sym">(</span><span class="src-str">'simpletest/autorun.php'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><span class="src-inc">require_once</span><span class="src-sym">(</span><span class="src-str">'database_connection.php'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line"><span class="src-id"><a href="../SimpleTest/MockObjects/Mock.html">Mock</a></span><span class="src-sym">::</span><a href="../SimpleTest/MockObjects/Mock.html#methodgenerate">generate</a><span class="src-sym">(</span><span class="src-str">'DatabaseConnection'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">MyTestCase&nbsp;</span><span class="src-key">extends&nbsp;</span><a href="../SimpleTest/UnitTester/UnitTestCase.html">UnitTestCase</a>&nbsp;<span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">testSomething</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$connection&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">MockDatabaseConnection</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                The mock version now has all the methods of the original.
                Also, any type hints will be faithfully preserved.
                Say our query methods expect a Query object...
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">DatabaseConnection&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">DatabaseConnection</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span><span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">query</span><span class="src-sym">(</span><span class="src-id">Query&nbsp;</span><span class="src-var">$query</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span><span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">selectQuery</span><span class="src-sym">(</span><span class="src-id">Query&nbsp;</span><span class="src-var">$query</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span><span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                If we now pass the wrong type of object, or worse a non-object...
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">MyTestCase&nbsp;</span><span class="src-key">extends&nbsp;</span><a href="../SimpleTest/UnitTester/UnitTestCase.html">UnitTestCase</a>&nbsp;<span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">testSomething</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$connection&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">MockDatabaseConnection</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$connection</span><span class="src-sym">-&gt;</span><span class="src-id">query</span><span class="src-sym">(</span><span class="src-str">'insert&nbsp;into&nbsp;accounts&nbsp;()&nbsp;values&nbsp;()'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                ...the code will throw a type violation at you just as the
                original class would.</p>
            <p>The mock version now has all the methods of the original.
                Unfortunately, they all return null.
                As methods that always return null are not that useful,
                we need to be able to set them to something else...</p>
            <p><div class="title">Mocks as actors</div></p>
            <p>Changing the return value of a method from null
                to something else is pretty easy...
<div class="src-code"><ol><li><div class="src-line"><span class="src-var">$connection</span><span class="src-sym">-&gt;</span><span class="src-id">returns</span><span class="src-sym">(</span><span class="src-str">'query'</span><span class="src-sym">,&nbsp;</span><span class="src-num">37</span><span class="src-sym">)</span></div></li>
</ol></div>
                Now every time we call
                $connection-&gt;query() we get
                the result of 37.
                There is nothing special about 37.
                The return value can be arbitrarily complicated.</p>
            <p>Parameters are irrelevant here, we always get the same
                values back each time once they have been set up this way.
                That may not sound like a convincing replica of a
                database connection, but for the half a dozen lines of
                a test method it is usually all you need.</p>
            <p>Things aren't always that simple though.
                One common problem is iterators, where constantly returning
                the same value could cause an endless loop in the object
                being tested.
                For these we need to set up sequences of values.
                Let's say we have a simple iterator that looks like this...
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">Iterator&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">Iterator</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span><span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">next</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span><span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                This is about the simplest iterator you could have.
                Assuming that this iterator only returns text until it
                reaches the end, when it returns false, we can simulate it
                with...
<div class="src-code"><ol><li><div class="src-line"><span class="src-id"><a href="../SimpleTest/MockObjects/Mock.html">Mock</a></span><span class="src-sym">::</span><a href="../SimpleTest/MockObjects/Mock.html#methodgenerate">generate</a><span class="src-sym">(</span><span class="src-str">'Iterator'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">IteratorTest&nbsp;</span><span class="src-key">extends&nbsp;</span><a href="../SimpleTest/UnitTester/UnitTestCase.html">UnitTestCase</a><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">testASequence</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$iterator&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">MockIterator</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$iterator</span><span class="src-sym">-&gt;</span><span class="src-id">returns</span><span class="src-sym">(</span><span class="src-str">'next'</span><span class="src-sym">,&nbsp;</span><span class="src-id">false</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$iterator</span><span class="src-sym">-&gt;</span><span class="src-id">returnsAt</span><span class="src-sym">(</span><span class="src-num">0</span><span class="src-sym">,&nbsp;</span><span class="src-str">'next'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'First&nbsp;string'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$iterator</span><span class="src-sym">-&gt;</span><span class="src-id">returnsAt</span><span class="src-sym">(</span><span class="src-num">1</span><span class="src-sym">,&nbsp;</span><span class="src-str">'next'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'Second&nbsp;string'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                When next() is called on the
                MockIterator it will first return &quot;First string&quot;,
                on the second call &quot;Second string&quot; will be returned
                and on any other call false will
                be returned.
                The sequenced return values take precedence over the constant
                return value.
                The constant one is a kind of default if you like.</p>
            <p>Another tricky situation is an overloaded
                get() operation.
                An example of this is an information holder with name/value pairs.
                Say we have a configuration class like...
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">Configuration&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">Configuration</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span>...&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">get</span><span class="src-sym">(</span><span class="src-var">$key</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span>...&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                This is a likely situation for using mock objects, as
                actual configuration will vary from machine to machine and
                even from test to test.
                The problem though is that all the data comes through the
                get() method and yet
                we want different results for different keys.
                Luckily the mocks have a filter system...
<div class="src-code"><ol><li><div class="src-line"><span class="src-var">$config&nbsp;</span>=&nbsp;<span class="src-sym">&amp;</span><span class="src-key">new&nbsp;</span><span class="src-id">MockConfiguration</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><span class="src-var">$config</span><span class="src-sym">-&gt;</span><span class="src-id">returns</span><span class="src-sym">(</span><span class="src-str">'get'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'primary'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'db_host'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><span class="src-var">$config</span><span class="src-sym">-&gt;</span><span class="src-id">returns</span><span class="src-sym">(</span><span class="src-str">'get'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'admin'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'db_user'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><span class="src-var">$config</span><span class="src-sym">-&gt;</span><span class="src-id">returns</span><span class="src-sym">(</span><span class="src-str">'get'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'secret'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'db_password'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
</ol></div>
                The extra parameter is a list of arguments to attempt
                to match.
                In this case we are trying to match only one argument which
                is the look up key.
                Now when the mock object has the
                get() method invoked
                like this...
<div class="src-code"><ol><li><div class="src-line"><span class="src-var">$config</span><span class="src-sym">-&gt;</span><span class="src-id">get</span><span class="src-sym">(</span><span class="src-str">'db_user'</span><span class="src-sym">)</span></div></li>
</ol></div>
                ...it will return &quot;admin&quot;.
                It finds this by attempting to match the calling arguments
                to its list of returns one after another until
                a complete match is found.</p>
            <p>You can set a default argument argument like so...
<div class="src-code"><ol><li><div class="src-line"><span class="src-var">$config</span><span class="src-sym">-&gt;</span><span class="src-id">returns</span><span class="src-sym">(</span><span class="src-str">'get'</span><span class="src-sym">,&nbsp;</span><span class="src-id">false</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'*'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
</ol></div>
                This is not the same as setting the return value without
                any argument requirements like this...
<div class="src-code"><ol><li><div class="src-line"><span class="src-var">$config</span><span class="src-sym">-&gt;</span><span class="src-id">returns</span><span class="src-sym">(</span><span class="src-str">'get'</span><span class="src-sym">,&nbsp;</span><span class="src-id">false</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
</ol></div>
                In the first case it will accept any single argument,
                but exactly one is required.
                In the second case any number of arguments will do and
                it acts as a catchall after all other matches.
                Note that if we add further single parameter options after
                the wildcard in the first case, they will be ignored as the wildcard
                will match first.
                With complex parameter lists the ordering could be important
                or else desired matches could be masked by earlier wildcard
                ones.
                Declare the most specific matches first if you are not sure.</p>
            <p>There are times when you want a specific reference to be
                dished out by the mock rather than a copy or object handle.
                This a rarity to say the least, but you might be simulating
                a container that can hold primitives such as strings.
                For example...
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">Pad&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">Pad</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span><span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-sym">&amp;</span><span class="src-id">note</span><span class="src-sym">(</span><span class="src-var">$index</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span><span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                In this case you can set a reference into the mock's
                return list...
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">function&nbsp;</span><span class="src-id">testTaskReads</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$note&nbsp;</span>=&nbsp;<span class="src-str">'Buy&nbsp;books'</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$pad&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">MockPad</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$vector</span><span class="src-sym">-&gt;</span><span class="src-id">returnsByReference</span><span class="src-sym">(</span><span class="src-str">'note'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$note</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-num">3</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$task&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">Task</span><span class="src-sym">(</span><span class="src-var">$pad</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;...</div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                With this arrangement you know that every time
                $pad-&gt;note(3) is
                called it will return the same $note each time,
                even if it get's modified.</p>
            <p>These three factors, timing, parameters and whether to copy,
                can be combined orthogonally.
                For example...
<div class="src-code"><ol><li><div class="src-line"><span class="src-var">$buy_books&nbsp;</span>=&nbsp;<span class="src-str">'Buy&nbsp;books'</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><span class="src-var">$write_code&nbsp;</span>=&nbsp;<span class="src-str">'Write&nbsp;code'</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><span class="src-var">$pad&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">MockPad</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><span class="src-var">$vector</span><span class="src-sym">-&gt;</span><span class="src-id">returnsByReferenceAt</span><span class="src-sym">(</span><span class="src-num">0</span><span class="src-sym">,&nbsp;</span><span class="src-str">'note'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$buy_books</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'*'</span><span class="src-sym">,&nbsp;</span><span class="src-num">3</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><span class="src-var">$vector</span><span class="src-sym">-&gt;</span><span class="src-id">returnsByReferenceAt</span><span class="src-sym">(</span><span class="src-num">1</span><span class="src-sym">,&nbsp;</span><span class="src-str">'note'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$write_code</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'*'</span><span class="src-sym">,&nbsp;</span><span class="src-num">3</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
</ol></div>
                This will return a reference to $buy_books and
                then to $write_code, but only if two parameters
                were set the second of which must be the integer 3.
                That should cover most situations.</p>
            <p>A final tricky case is one object creating another, known
                as a factory pattern.
                Suppose that on a successful query to our imaginary
                database, a result set is returned as an iterator, with
                each call to the the iterator's next() giving
                one row until false.
                This sounds like a simulation nightmare, but in fact it can all
                be mocked using the mechanics above...
<div class="src-code"><ol><li><div class="src-line"><span class="src-id"><a href="../SimpleTest/MockObjects/Mock.html">Mock</a></span><span class="src-sym">::</span><a href="../SimpleTest/MockObjects/Mock.html#methodgenerate">generate</a><span class="src-sym">(</span><span class="src-str">'DatabaseConnection'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><span class="src-id"><a href="../SimpleTest/MockObjects/Mock.html">Mock</a></span><span class="src-sym">::</span><a href="../SimpleTest/MockObjects/Mock.html#methodgenerate">generate</a><span class="src-sym">(</span><span class="src-str">'ResultIterator'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">DatabaseTest&nbsp;</span><span class="src-key">extends&nbsp;</span><a href="../SimpleTest/UnitTester/UnitTestCase.html">UnitTestCase</a>&nbsp;<span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">testUserFinderReadsResultsFromDatabase</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$result&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">MockResultIterator</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$result</span><span class="src-sym">-&gt;</span><span class="src-id">returns</span><span class="src-sym">(</span><span class="src-str">'next'</span><span class="src-sym">,&nbsp;</span><span class="src-id">false</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$result</span><span class="src-sym">-&gt;</span><span class="src-id">returnsAt</span><span class="src-sym">(</span><span class="src-num">0</span><span class="src-sym">,&nbsp;</span><span class="src-str">'next'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-num">1</span><span class="src-sym">,&nbsp;</span><span class="src-str">'tom'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$result</span><span class="src-sym">-&gt;</span><span class="src-id">returnsAt</span><span class="src-sym">(</span><span class="src-num">1</span><span class="src-sym">,&nbsp;</span><span class="src-str">'next'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-num">3</span><span class="src-sym">,&nbsp;</span><span class="src-str">'dick'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$result</span><span class="src-sym">-&gt;</span><span class="src-id">returnsAt</span><span class="src-sym">(</span><span class="src-num">2</span><span class="src-sym">,&nbsp;</span><span class="src-str">'next'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-num">6</span><span class="src-sym">,&nbsp;</span><span class="src-str">'harry'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$connection&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">MockDatabaseConnection</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$connection</span><span class="src-sym">-&gt;</span><span class="src-id">returns</span><span class="src-sym">(</span><span class="src-str">'selectQuery'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$result</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$finder&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">UserFinder</span><span class="src-sym">(</span><span class="src-var">$connection</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$this</span><span class="src-sym">-&gt;</span><span class="src-id">assertIdentical</span><span class="src-sym">(</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$finder</span><span class="src-sym">-&gt;</span><span class="src-id">findNames</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">,</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'tom'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'dick'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'harry'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                Now only if our
                $connection is called with the
                query() method will the
                $result be returned that is
                itself exhausted after the third call to next().
                This should be enough
                information for our UserFinder class,
                the class actually
                being tested here, to come up with goods.
                A very precise test and not a real database in sight.</p>
            <p>We could refine this test further by insisting that the correct
                query is sent...
<div class="src-code"><ol><li><div class="src-line"><span class="src-var">$connection</span><span class="src-sym">-&gt;</span><span class="src-id">returns</span><span class="src-sym">(</span><span class="src-str">'selectQuery'</span><span class="src-sym">,&nbsp;</span><span class="src-var">$result</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'select&nbsp;name,&nbsp;id&nbsp;from&nbsp;people'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
</ol></div>
                This is actually a bad idea.</p>
            <p>We have a UserFinder in object land, talking to
                database tables using a large interface - the whole of SQL.
                Imagine that we have written a lot of tests that now depend
                on the exact SQL string passed.
                These queries could change en masse for all sorts of reasons
                not related to the specific test.
                For example the quoting rules could change, a table name could
                change, a link table added or whatever.
                This would require the rewriting of every single test any time
                one of these refactoring is made, yet the intended behaviour has
                stayed the same.
                Tests are supposed to help refactoring, not hinder it.
                I'd certainly like to have a test suite that passes while I change
                table names.</p>
            <p>As a rule it is best not to mock a fat interface.</p>
            <p>By contrast, here is the round trip test...
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">DatabaseTest&nbsp;</span><span class="src-key">extends&nbsp;</span><a href="../SimpleTest/UnitTester/UnitTestCase.html">UnitTestCase</a>&nbsp;<span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">setUp</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span>...&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">tearDown</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span>...&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">testUserFinderReadsResultsFromDatabase</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$finder&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">UserFinder</span><span class="src-sym">(</span><span class="src-key">new&nbsp;</span><span class="src-id">DatabaseConnection</span><span class="src-sym">(</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$finder</span><span class="src-sym">-&gt;</span><span class="src-id">add</span><span class="src-sym">(</span><span class="src-str">'tom'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$finder</span><span class="src-sym">-&gt;</span><span class="src-id">add</span><span class="src-sym">(</span><span class="src-str">'dick'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$finder</span><span class="src-sym">-&gt;</span><span class="src-id">add</span><span class="src-sym">(</span><span class="src-str">'harry'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$this</span><span class="src-sym">-&gt;</span><span class="src-id">assertIdentical</span><span class="src-sym">(</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$finder</span><span class="src-sym">-&gt;</span><span class="src-id">findNames</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">,</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'tom'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'dick'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'harry'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                This test is immune to schema changes.
                It will only fail if you actually break the functionality, which
                is what you want a test to do.</p>
            <p>The catch is those setUp() and tearDown()
                methods that we've rather glossed over.
                They have to clear out the database tables and ensure that the
                schema is defined correctly.
                That can be a chunk of extra work, but you usually have this code
                lying around anyway for deployment purposes.</p>
            <p>One place where you definitely need a mock is simulating failures.
                Say the database goes down while UserFinder is doing
                it's work.
                Does UserFinder behave well...?
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">DatabaseTest&nbsp;</span><span class="src-key">extends&nbsp;</span><a href="../SimpleTest/UnitTester/UnitTestCase.html">UnitTestCase</a>&nbsp;<span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">testUserFinder</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$connection&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">MockDatabaseConnection</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$connection</span><span class="src-sym">-&gt;</span><span class="src-id">throwOn</span><span class="src-sym">(</span><span class="src-str">'selectQuery'</span><span class="src-sym">,&nbsp;</span><span class="src-key">new&nbsp;</span><span class="src-id">TimedOut</span><span class="src-sym">(</span><span class="src-str">'Ouch!'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">MockAlerts</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert</span><span class="src-sym">-&gt;</span><span class="src-id">expectOnce</span><span class="src-sym">(</span><span class="src-str">'notify'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'Database&nbsp;is&nbsp;busy&nbsp;-&nbsp;please&nbsp;retry'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$finder&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">UserFinder</span><span class="src-sym">(</span><span class="src-var">$connection</span><span class="src-sym">,&nbsp;</span><span class="src-var">$alert</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$this</span><span class="src-sym">-&gt;</span><span class="src-id">assertIdentical</span><span class="src-sym">(</span><span class="src-var">$finder</span><span class="src-sym">-&gt;</span><span class="src-id">findNames</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                We've passed the UserFinder an $alert
                object.
                This is going to do some kind of pretty notifications in the
                user interface in the event of an error.
                We'd rather not sprinkle our code with hard wired print
                statements if we can avoid it.
                Wrapping the means of output means we can use this code anywhere.
                It also makes testing easier.</p>
            <p>To pass this test, the finder has to write a nice user friendly
                message to $alert, rather than propogating the exception.
                So far, so good.</p>
            <p>How do we get the mock DatabaseConnection to throw an exception?
                We generate the exception using the throwOn method
                on the mock.</p>
            <p>Finally, what if the method you want to simulate does not exist yet?
                If you set a return value on a method that is not there, SimpleTest
                will throw an error.
                What if you are using __call() to simulate dynamic methods?</p>
            <p>Objects with dynamic interfaces, using __call, can
                be problematic with the current mock objects implementation.
                You can mock the __call() method, but this is ugly.
                Why should a test know anything about such low level implementation details?
                It just wants to simulate the call.</p>
            <p>The way round this is to add extra methods to the mock when
                generating it.
<div class="src-code"><ol><li><div class="src-line"><span class="src-id"><a href="../SimpleTest/MockObjects/Mock.html">Mock</a></span><span class="src-sym">::</span><a href="../SimpleTest/MockObjects/Mock.html#methodgenerate">generate</a><span class="src-sym">(</span><span class="src-str">'DatabaseConnection'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'MockDatabaseConnection'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'setOptions'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
</ol></div>
                In a large test suite this could cause trouble, as you probably
                already have a mock version of the class called
                MockDatabaseConnection without the extra methods.
                The code generator will not generate a mock version of the class if
                one of the same name already exists.
                You will confusingly fail to see your method if another definition
                was run first.</p>
            <p>To cope with this, SimpleTest allows you to choose any name for the
                new class at the same time as you add the extra methods.
<div class="src-code"><ol><li><div class="src-line"><span class="src-id"><a href="../SimpleTest/MockObjects/Mock.html">Mock</a></span><span class="src-sym">::</span><a href="../SimpleTest/MockObjects/Mock.html#methodgenerate">generate</a><span class="src-sym">(</span><span class="src-str">'DatabaseConnection'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'MockDatabaseConnectionWithOptions'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'setOptions'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
</ol></div>
                Here the mock will behave as if the setOptions()
                existed in the original class.</p>
            <p>Mock objects can only be used within test cases, as upon expectations
                they send messages straight to the currently running test case.
                Creating them outside a test case will cause a run time error
                when an expectation is triggered and there is no running test case
                for the message to end up.
                We cover expectations next.</p></span>
        <span><a name="expectations"></a><h2 class="title">Mocks as critics</h2><p>Although the server stubs approach insulates your tests from
                real world disruption, it is only half the benefit.
                You can have the class under test receiving the required
                messages, but is your new class sending correct ones?
                Testing this can get messy without a mock objects library.</p>
			<p>By way of example, let's take a simple PageController
                class to handle a credit card payment form...
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">PaymentForm&nbsp;</span><span class="src-key">extends&nbsp;</span><span class="src-id">PageController&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">__construct</span><span class="src-sym">(</span><span class="src-var">$alert</span><span class="src-sym">,&nbsp;</span><span class="src-var">$payment_gateway</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span>...&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">makePayment</span><span class="src-sym">(</span><span class="src-var">$request</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span>...&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                This class takes a PaymentGateway to actually talk
                to the bank.
                It also takes an Alert object to handle errors.
                This class talks to the page or template.
                It's responsible for painting the error message and highlighting any
                form fields that are incorrect.</p>
            <p>It might look something like...
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">Alert&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">warn</span><span class="src-sym">(</span><span class="src-var">$warning</span><span class="src-sym">,&nbsp;</span><span class="src-var">$id</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;<span class="src-str">'&lt;div&nbsp;class=&quot;warning&quot;&gt;'&nbsp;</span>.&nbsp;<span class="src-var">$warning&nbsp;</span>.&nbsp;<span class="src-str">'&lt;/div&gt;'</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;<span class="src-str">'&lt;style&nbsp;type=&quot;text/css&quot;&gt;#'&nbsp;</span>.&nbsp;<span class="src-var">$id&nbsp;</span>.&nbsp;<span class="src-str">'&nbsp;{&nbsp;background-color:&nbsp;red&nbsp;}&lt;/style&gt;'</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div></p>
            <p>Our interest is in the makePayment() method.
                If we fail to enter a &quot;CVV2&quot; number (the three digit number
                on the back of the credit card), we want to show an error rather than
                try to process the payment.
                In test form...
<div class="src-code"><ol><li><div class="src-line"><span class="src-php">&lt;?php</span></div></li>
<li><div class="src-line"><span class="src-inc">require_once</span><span class="src-sym">(</span><span class="src-str">'simpletest/autorun.php'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><span class="src-inc">require_once</span><span class="src-sym">(</span><span class="src-str">'payment_form.php'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><span class="src-id"><a href="../SimpleTest/MockObjects/Mock.html">Mock</a></span><span class="src-sym">::</span><a href="../SimpleTest/MockObjects/Mock.html#methodgenerate">generate</a><span class="src-sym">(</span><span class="src-str">'Alert'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><span class="src-id"><a href="../SimpleTest/MockObjects/Mock.html">Mock</a></span><span class="src-sym">::</span><a href="../SimpleTest/MockObjects/Mock.html#methodgenerate">generate</a><span class="src-sym">(</span><span class="src-str">'PaymentGateway'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">PaymentFormFailuresShouldBeGraceful&nbsp;</span><span class="src-key">extends&nbsp;</span><a href="../SimpleTest/UnitTester/UnitTestCase.html">UnitTestCase</a>&nbsp;<span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">testMissingCvv2CausesAlert</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">MockAlert</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert</span><span class="src-sym">-&gt;</span><span class="src-id">expectOnce</span><span class="src-sym">(</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-str">'warn'</span><span class="src-sym">,</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'Missing&nbsp;three&nbsp;digit&nbsp;security&nbsp;code'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'cvv2'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$controller&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">PaymentForm</span><span class="src-sym">(</span><span class="src-var">$alert</span><span class="src-sym">,&nbsp;</span><span class="src-key">new&nbsp;</span><span class="src-id">MockPaymentGateway</span><span class="src-sym">(</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$controller</span><span class="src-sym">-&gt;</span><span class="src-id">makePayment</span><span class="src-sym">(</span><span class="src-var">$this</span><span class="src-sym">-&gt;</span><span class="src-id">requestWithMissingCvv2</span><span class="src-sym">(</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">requestWithMissingCvv2</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span>...&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-php">?&gt;</span></div></li>
</ol></div>
                The first question you may be asking is, where are the assertions?</p>
            <p>The call to expectOnce('warn', array(...)) instructs the mock
                to expect a call to warn() before the test ends.
                When it gets a call to warn(), it checks the arguments.
                If the arguments don't match, then a failure is generated.
                It also fails if the method is never called at all.</p>
            <p>The test above not only asserts that warn was called,
                but that it received the string &quot;Missing three digit security code&quot;
                and also the tag &quot;cvv2&quot;.
                The equivalent of assertIdentical() is applied to both
                fields when the parameters are compared.</p>
            <p>If you are not interested in the actual message, and we are not
                for user interface code that changes often, we can skip that
                parameter with the &quot;*&quot; operator...
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">PaymentFormFailuresShouldBeGraceful&nbsp;</span><span class="src-key">extends&nbsp;</span><a href="../SimpleTest/UnitTester/UnitTestCase.html">UnitTestCase</a>&nbsp;<span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">testMissingCvv2CausesAlert</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">MockAlert</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert</span><span class="src-sym">-&gt;</span><span class="src-id">expectOnce</span><span class="src-sym">(</span><span class="src-str">'warn'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'*'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'cvv2'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$controller&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">PaymentForm</span><span class="src-sym">(</span><span class="src-var">$alert</span><span class="src-sym">,&nbsp;</span><span class="src-key">new&nbsp;</span><span class="src-id">MockPaymentGateway</span><span class="src-sym">(</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$controller</span><span class="src-sym">-&gt;</span><span class="src-id">makePayment</span><span class="src-sym">(</span><span class="src-var">$this</span><span class="src-sym">-&gt;</span><span class="src-id">requestWithMissingCvv2</span><span class="src-sym">(</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">requestWithMissingCvv2</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span>...&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                We can weaken the test further by missing
                out the parameters array...
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">function&nbsp;</span><span class="src-id">testMissingCvv2CausesAlert</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">MockAlert</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert</span><span class="src-sym">-&gt;</span><span class="src-id">expectOnce</span><span class="src-sym">(</span><span class="src-str">'warn'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$controller&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">PaymentForm</span><span class="src-sym">(</span><span class="src-var">$alert</span><span class="src-sym">,&nbsp;</span><span class="src-key">new&nbsp;</span><span class="src-id">MockPaymentGateway</span><span class="src-sym">(</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$controller</span><span class="src-sym">-&gt;</span><span class="src-id">makePayment</span><span class="src-sym">(</span><span class="src-var">$this</span><span class="src-sym">-&gt;</span><span class="src-id">requestWithMissingCvv2</span><span class="src-sym">(</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                This will only test that the method is called,
                which is a bit drastic in this case.
                Later on, we'll see how we can weaken the expectations more precisely.</p>
            <p>Tests without assertions can be both compact and very expressive.
                Because we intercept the call on the way into an object, here of
                the Alert class, we avoid having to assert its state
                afterwards.
                This not only avoids the assertions in the tests, but also having
                to add extra test only accessors to the original code.
                If you catch yourself adding such accessors, called &quot;state based testing&quot;,
                it's probably time to consider using mocks in the tests.
                This is called &quot;behaviour based testing&quot;, and is normally superior.</p>
            <p>Let's add another test.
                Let's make sure that we don't even attempt a payment without a CVV2...
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">class&nbsp;</span><span class="src-id">PaymentFormFailuresShouldBeGraceful&nbsp;</span><span class="src-key">extends&nbsp;</span><a href="../SimpleTest/UnitTester/UnitTestCase.html">UnitTestCase</a>&nbsp;<span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">testMissingCvv2CausesAlert</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{&nbsp;</span>...&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-key">function&nbsp;</span><span class="src-id">testNoPaymentAttemptedWithMissingCvv2</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$payment_gateway&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">MockPaymentGateway</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$payment_gateway</span><span class="src-sym">-&gt;</span><span class="src-id">expectNever</span><span class="src-sym">(</span><span class="src-str">'pay'</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$controller&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">PaymentForm</span><span class="src-sym">(</span><span class="src-key">new&nbsp;</span><span class="src-id">MockAlert</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">,&nbsp;</span><span class="src-var">$payment_gateway</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$controller</span><span class="src-sym">-&gt;</span><span class="src-id">makePayment</span><span class="src-sym">(</span><span class="src-var">$this</span><span class="src-sym">-&gt;</span><span class="src-id">requestWithMissingCvv2</span><span class="src-sym">(</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-sym">}</span></div></li>
<li><div class="src-line">&nbsp;</div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;...</div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                Asserting a negative can be very hard in tests, but
                expectNever() makes it easy.</p>
            <p>expectOnce() and expectNever() are
                sufficient for most tests, but
                occasionally you want to test multiple events.
                Normally for usability purposes we want all missing fields
                in the form to light up, not just the first one.
                This means that we should get multiple calls to
                Alert::warn(), not just one...
<div class="src-code"><ol><li><div class="src-line"><span class="src-key">function&nbsp;</span><span class="src-id">testAllRequiredFieldsHighlightedOnEmptyRequest</span><span class="src-sym">(</span><span class="src-sym">)&nbsp;</span><span class="src-sym">{</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">MockAlert</span><span class="src-sym">(</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert</span><span class="src-sym">-&gt;</span><span class="src-id">expectAt</span><span class="src-sym">(</span><span class="src-num">0</span><span class="src-sym">,&nbsp;</span><span class="src-str">'warn'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'*'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'cc_number'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert</span><span class="src-sym">-&gt;</span><span class="src-id">expectAt</span><span class="src-sym">(</span><span class="src-num">1</span><span class="src-sym">,&nbsp;</span><span class="src-str">'warn'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'*'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'expiry'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert</span><span class="src-sym">-&gt;</span><span class="src-id">expectAt</span><span class="src-sym">(</span><span class="src-num">2</span><span class="src-sym">,&nbsp;</span><span class="src-str">'warn'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'*'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'cvv2'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert</span><span class="src-sym">-&gt;</span><span class="src-id">expectAt</span><span class="src-sym">(</span><span class="src-num">3</span><span class="src-sym">,&nbsp;</span><span class="src-str">'warn'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'*'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'card_holder'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert</span><span class="src-sym">-&gt;</span><span class="src-id">expectAt</span><span class="src-sym">(</span><span class="src-num">4</span><span class="src-sym">,&nbsp;</span><span class="src-str">'warn'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'*'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'address'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert</span><span class="src-sym">-&gt;</span><span class="src-id">expectAt</span><span class="src-sym">(</span><span class="src-num">5</span><span class="src-sym">,&nbsp;</span><span class="src-str">'warn'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'*'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'postcode'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert</span><span class="src-sym">-&gt;</span><span class="src-id">expectAt</span><span class="src-sym">(</span><span class="src-num">6</span><span class="src-sym">,&nbsp;</span><span class="src-str">'warn'</span><span class="src-sym">,&nbsp;</span><span class="src-key">array</span><span class="src-sym">(</span><span class="src-str">'*'</span><span class="src-sym">,&nbsp;</span><span class="src-str">'country'</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$alert</span><span class="src-sym">-&gt;</span><span class="src-id">expectCallCount</span><span class="src-sym">(</span><span class="src-str">'warn'</span><span class="src-sym">,&nbsp;</span><span class="src-num">7</span><span class="src-sym">)</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$controller&nbsp;</span>=&nbsp;<span class="src-key">new&nbsp;</span><span class="src-id">PaymentForm</span><span class="src-sym">(</span><span class="src-var">$alert</span><span class="src-sym">,&nbsp;</span><span class="src-key">new&nbsp;</span><span class="src-id">MockPaymentGateway</span><span class="src-sym">(</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="src-var">$controller</span><span class="src-sym">-&gt;</span><span class="src-id">makePayment</span><span class="src-sym">(</span><span class="src-var">$this</span><span class="src-sym">-&gt;</span><span class="src-id">requestWithMissingCvv2</span><span class="src-sym">(</span><span class="src-sym">))</span><span class="src-sym">;</span></div></li>
<li><div class="src-line"><span class="src-sym">}</span></div></li>
</ol></div>
                The counter in expectAt() is the number of times
                the method has been called already.
                Here we are asserting that every field will be highlighted.</p>
            <p>Note that we are forced to assert the order too.
                SimpleTest does not yet have a way to avoid this, but
                this will be fixed in future versions.</p>
            <p>Here is the full list of expectations you can set on a mock object
                in <a href="http://simpletest.org/">SimpleTest</a>.
                As with the assertions, these methods take an optional failure message.
                <table frame = "border"><thead><tr>Expectation
Description</tr></thead>
                    <tbody><tr><td>expect($method, $args)</td>
                            <td>Arguments must match if called</td></tr>
                        <tr><td>expectAt($timing, $method, $args)</td>
                            <td>Arguments must match when called on the $timing'th time</td></tr>
                        <tr><td>expectCallCount($method, $count)</td>
                            <td>The method must be called exactly this many times</td></tr>
                        <tr><td>expectMaximumCallCount($method, $count)</td>
                            <td>Call this method no more than $count times</td></tr>
                        <tr><td>expectMinimumCallCount($method, $count)</td>
                            <td>Must be called at least $count times</td></tr>
                        <tr><td>expectNever($method)</td>
                            <td>Must never be called</td></tr>
                        <tr><td>expectOnce($method, $args)</td>
                            <td>Must be called once and with the expected arguments if supplied</td></tr>
                        <tr><td>expectAtLeastOnce($method, $args)</td>
                            <td>Must be called at least once, and always with any expected arguments</td></tr></tbody></table>
                Where the parameters are...
                $method
                    The method name, as a string, to apply the condition to.
                    $args
                    The arguments as a list. Wildcards can be included in the same
                        manner as for setReturn().
                        This argument is optional for expectOnce()
                        and expectAtLeastOnce().
                    $timing
                    The only point in time to test the condition.
                        The first call starts at zero and the count is for
                        each method independently.
                    $count
                    The number of calls expected.</p>
            <p>If you have just one call in your test, make sure you're using
                expectOnce.
                Using $mocked-&gt;expectAt(0, 'method', 'args);
                on its own will allow the method to never be called.
                Checking the arguments and the overall call count
                are currently independant.
                Add an expectCallCount() expectation when you
                are using expectAt() unless zero calls is allowed.</p>
            <p>Like the assertions within test cases, all of the expectations
                can take a message override as an extra parameter.
                Also the original failure message can be embedded in the output
                as &quot;%s&quot;.</p></span></div>

	<table class="tutorial-nav-box">
	<tr>
		<td style="width: 30%">
							<a href="../SimpleTest/tutorial_GroupTests.pkg.html" class="nav-button">Previous</a>
					</td>
		<td style="text-align: center">
							<a href="../SimpleTest/tutorial_SimpleTest.pkg.html" class="nav-button">Up</a>
					</td>
		<td style="text-align: right; width: 30%">
							<a href="../SimpleTest/tutorial_PartialMock.pkg.html" class="nav-button">Next</a>
					</td>
	</tr>
	<tr>
		<td style="width: 30%">
							<span class="detail">Group tests</span>
					</td>
		<td style="text-align: center">
							<span class="detail">Simple Test PHP Unit Test Framework</span>
					</td>
		<td style="text-align: right; width: 30%">
							<span class="detail">Partial mocks</span>
					</td>
	</tr>
</table>
	
	<p class="notes" id="credit">
		Documentation generated on Fri, 20 Jan 2012 01:58:40 +0100 by <a href="http://www.phpdoc.org" target="_blank">phpDocumentor 1.4.3</a>
	</p>
	</div></body>
</html>